<article class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
  <% if content_item.og_image_url.present? %>
    <div class="aspect-video overflow-hidden">
      <img src="<%= content_item.og_image_url %>" alt="" class="w-full h-full object-cover" loading="lazy">
    </div>
  <% end %>
  <div class="p-6">
    <div class="flex items-center justify-between mb-3">
      <%# Topic tags as pills %>
      <div class="flex flex-wrap gap-1">
        <% if content_item.topic_tags.any? %>
          <% content_item.topic_tags.first(2).each do |tag| %>
            <%= link_to tag.titleize, feed_index_path(tag: tag), class: "inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors" %>
          <% end %>
          <% if content_item.topic_tags.size > 2 %>
            <%= badge("+#{content_item.topic_tags.size - 2}", :gray) %>
          <% end %>
        <% elsif content_item.content_type.present? %>
          <%= badge(content_item.content_type.titleize, :gray) %>
        <% end %>
      </div>

      <%# Published time %>
      <% if content_item.published_at %>
        <time class="text-sm text-gray-500 whitespace-nowrap" datetime="<%= content_item.published_at.iso8601 %>">
          <%= t('time.ago', time: time_ago_in_words(content_item.published_at)) %>
        </time>
      <% end %>
    </div>

    <%# Title with external link %>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">
      <%= link_to content_item.title || t('feed.content.untitled'),
                  content_item.url_canonical,
                  target: "_blank",
                  rel: "noopener noreferrer",
                  class: "hover:text-blue-600 transition-colors",
                  data: {
                    controller: "track-view",
                    action: "click->track-view#track",
                    track_view_content_id_value: content_item.id
                  } %>
    </h3>

    <%# AI Summary or Description fallback %>
    <% summary = content_item.ai_summary.presence || content_item.summary.presence || content_item.description %>
    <% if summary.present? %>
      <p class="text-gray-600 text-sm line-clamp-3 mb-3">
        <%= truncate(summary, length: 200) %>
      </p>
    <% end %>

    <%# Why it matters (if available) %>
    <% if content_item.respond_to?(:why_it_matters) && content_item.why_it_matters.present? %>
      <div class="bg-amber-50 rounded-md p-3 mb-3">
        <p class="text-sm text-amber-800">
          <span class="font-medium"><%= t('feed.content.why_it_matters') %></span>
          <%= truncate(content_item.why_it_matters, length: 150) %>
        </p>
      </div>
    <% end %>

    <%# Key takeaways (if available) %>
    <% if content_item.respond_to?(:key_takeaways) && content_item.key_takeaways.present? %>
      <details class="mb-3 group">
        <summary class="text-sm font-medium text-gray-700 cursor-pointer hover:text-blue-600 transition-colors">
          <%= t('feed.content.key_takeaways') %>
        </summary>
        <ul class="mt-2 space-y-1 text-sm text-gray-600 list-disc list-inside">
          <% content_item.key_takeaways.each do |takeaway| %>
            <li><%= takeaway %></li>
          <% end %>
        </ul>
      </details>
    <% end %>

    <%# Source, read time, quality score, and engagement %>
    <div class="flex items-center justify-between text-sm text-gray-500">
      <div class="flex items-center gap-2 truncate max-w-[60%]">
        <% if content_item.source_name.present? %>
          <span class="truncate" title="<%= content_item.source_name %>">
            <%= content_item.source_name %>
          </span>
        <% end %>
        <% if content_item.read_time_minutes.present? %>
          <span class="whitespace-nowrap">&middot; <%= content_item.read_time_minutes %> min read</span>
        <% end %>
        <% if content_item.respond_to?(:quality_score) && content_item.quality_score.present? %>
          <span class="whitespace-nowrap" title="<%= t('feed.content.quality_score_title') %>">
            &middot; <%= t('feed.content.quality_score_label', score: content_item.quality_score) %>
          </span>
        <% end %>
      </div>

      <%# Engagement indicators and actions %>
      <div class="flex items-center gap-2 sm:gap-3">
        <% if content_item.upvotes_count.to_i > 0 %>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
            </svg>
            <%= content_item.upvotes_count %>
          </span>
        <% end %>
        <% if content_item.comments_count.to_i > 0 %>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <%= content_item.comments_count %>
          </span>
        <% end %>
        <%# Bookmark button %>
        <%= render "bookmarks/button", bookmarkable: content_item %>

        <%# Flag button %>
        <% if user_signed_in? %>
          <% flagged = Flag.exists?(user: current_user, flaggable: content_item, site: Current.site) %>
          <%= render "flags/flag_button", flaggable: content_item, flagged: flagged %>
        <% end %>
      </div>
    </div>
  </div>
</article>
