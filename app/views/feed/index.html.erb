<% content_for :title, t('feed.index.title', site: Current.tenant&.title) %>

<div class="py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">
          <%= t('feed.index.heading') %>
        </h1>
        <p class="mt-2 text-gray-600"><%= t('feed.index.description', default: "The latest content from across the network") %></p>
      </div>
      <%= link_to feed_rss_path(format: :rss), class: "inline-flex items-center gap-2 px-4 py-2 text-sm text-orange-600 hover:text-orange-700 border border-orange-200 rounded-lg hover:bg-orange-50 transition-colors" do %>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
          <path d="M4 9a1 1 0 011-1 7 7 0 017 7 1 1 0 11-2 0 5 5 0 00-5-5 1 1 0 01-1-1z"/>
          <circle cx="5" cy="15" r="2"/>
        </svg>
        <%= t('feed.rss.subscribe') %>
      <% end %>
    </div>

    <%# Filter bar %>
    <div class="flex flex-wrap gap-4 mb-6">
      <%# Sort options %>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-500"><%= t('feed.filters.sort_by') %></span>
        <div class="flex rounded-lg border border-gray-200 bg-white overflow-hidden">
          <%= link_to t('feed.sort.ranked'),
                      feed_index_path(params.permit(:tag, :content_type).merge(sort: 'ranked')),
                      class: "px-3 py-1.5 text-sm #{params[:sort].blank? || params[:sort] == 'ranked' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}" %>
          <%= link_to t('feed.sort.latest'),
                      feed_index_path(params.permit(:tag, :content_type).merge(sort: 'latest')),
                      class: "px-3 py-1.5 text-sm border-l border-gray-200 #{params[:sort] == 'latest' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}" %>
          <%= link_to t('feed.sort.top_week'),
                      feed_index_path(params.permit(:tag, :content_type).merge(sort: 'top_week')),
                      class: "px-3 py-1.5 text-sm border-l border-gray-200 #{params[:sort] == 'top_week' ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-50'}" %>
        </div>
      </div>

      <%# Tag filter %>
      <% if @taxonomies.any? %>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500"><%= t('feed.filters.tag') %></span>
          <select onchange="window.location = this.value" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="<%= feed_index_path(params.permit(:sort, :content_type)) %>" <%= 'selected' if params[:tag].blank? %>>
              <%= t('feed.filters.all_tags') %>
            </option>
            <% @taxonomies.each do |taxonomy| %>
              <option value="<%= feed_index_path(params.permit(:sort, :content_type).merge(tag: taxonomy.slug)) %>" <%= 'selected' if params[:tag] == taxonomy.slug %>>
                <%= taxonomy.name %>
              </option>
            <% end %>
          </select>
        </div>
      <% end %>

      <%# Content type filter %>
      <% if @content_types.any? %>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500"><%= t('feed.filters.content_type') %></span>
          <select onchange="window.location = this.value" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="<%= feed_index_path(params.permit(:sort, :tag)) %>" <%= 'selected' if params[:content_type].blank? %>>
              <%= t('feed.filters.all_types') %>
            </option>
            <% @content_types.each do |content_type| %>
              <option value="<%= feed_index_path(params.permit(:sort, :tag).merge(content_type: content_type)) %>" <%= 'selected' if params[:content_type] == content_type %>>
                <%= content_type.titleize %>
              </option>
            <% end %>
          </select>
        </div>
      <% end %>

      <%# Clear filters %>
      <% if params[:tag].present? || params[:content_type].present? || params[:sort].present? %>
        <%= link_to t('feed.filters.clear'), feed_index_path, class: "text-sm text-gray-500 hover:text-gray-700 underline" %>
      <% end %>
    </div>
  </div>

  <% if @content_items.any? %>
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <% @content_items.each do |item| %>
        <%= render 'feed/content_card', content_item: item %>
      <% end %>
    </div>

    <%# Pagination %>
    <% if @content_items.size >= 20 %>
      <div class="mt-8 flex justify-center">
        <% current_page = [params[:page].to_i, 1].max %>
        <div class="flex items-center gap-2">
          <% if current_page > 1 %>
            <%= link_to t('feed.pagination.previous'),
                        feed_index_path(params.permit(:tag, :content_type, :sort).merge(page: current_page - 1)),
                        class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" %>
          <% end %>
          <span class="px-4 py-2 text-sm text-gray-500">
            <%= t('feed.pagination.page', page: current_page) %>
          </span>
          <%= link_to t('feed.pagination.next'),
                      feed_index_path(params.permit(:tag, :content_type, :sort).merge(page: current_page + 1)),
                      class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900"><%= t('feed.empty.title') %></h3>
      <p class="mt-1 text-sm text-gray-500"><%= t('feed.empty.description') %></p>
    </div>
  <% end %>
  </div>
</div>
