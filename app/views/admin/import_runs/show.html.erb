<div class="py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <%= link_to "← Back to Import Runs", admin_import_runs_path, class: "text-gray-600 hover:underline text-sm" %>
      <div class="mt-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Import Run #<%= @import_run.id %></h1>
          <p class="text-gray-500"><%= @import_run.source.name %></p>
        </div>
        <div>
          <% case @import_run.status %>
          <% when "completed" %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
              ✓ Completed
            </span>
          <% when "failed" %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800">
              ✗ Failed
            </span>
          <% else %>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
              ⏳ Running
            </span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500">Items Created</dt>
        <dd class="mt-1 text-3xl font-semibold text-green-600">+<%= @import_run.items_created %></dd>
      </div>
      <div class="bg-white shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500">Items Updated</dt>
        <dd class="mt-1 text-3xl font-semibold text-blue-600"><%= @import_run.items_updated %></dd>
      </div>
      <div class="bg-white shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500">Items Failed</dt>
        <dd class="mt-1 text-3xl font-semibold text-red-600"><%= @import_run.items_failed %></dd>
      </div>
      <div class="bg-white shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500">Total Processed</dt>
        <dd class="mt-1 text-3xl font-semibold text-gray-900"><%= @import_run.items_count %></dd>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Timing Details -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Timing</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
          <dl class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Started At</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @import_run.started_at.strftime("%Y-%m-%d %H:%M:%S UTC") %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Completed At</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @import_run.completed_at&.strftime("%Y-%m-%d %H:%M:%S UTC") || "Not completed" %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Duration</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <% if @import_run.completed_at && @import_run.started_at %>
                  <% duration_ms = ((@import_run.completed_at - @import_run.started_at) * 1000).round %>
                  <% if duration_ms > 1000 %>
                    <%= (duration_ms / 1000.0).round(2) %> seconds
                  <% else %>
                    <%= duration_ms %> ms
                  <% end %>
                <% elsif @import_run.running? %>
                  <span class="text-yellow-600">Still running...</span>
                <% else %>
                  N/A
                <% end %>
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <!-- Source Info -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Source</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
          <dl class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Name</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= link_to @import_run.source.name, admin_source_path(@import_run.source), class: "text-blue-600 hover:underline" %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Type</dt>
              <dd class="mt-1">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                  <%= @import_run.source.kind.start_with?('serp_api') ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800' %>">
                  <%= @import_run.source.kind.gsub('serp_api_', '').titleize %>
                </span>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Site</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @import_run.site.name %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Query</dt>
              <dd class="mt-1 text-sm text-gray-900 font-mono bg-gray-50 p-2 rounded">
                <%= @import_run.source.config["query"] || "N/A" %>
              </dd>
            </div>
          </dl>
        </div>
      </div>
    </div>

    <!-- Error Message (if failed) -->
    <% if @import_run.failed? && @import_run.error_message.present? %>
      <div class="mt-8 bg-red-50 shadow rounded-lg">
        <div class="px-4 py-5 border-b border-red-100 sm:px-6">
          <h3 class="text-lg leading-6 font-medium text-red-800">Error Details</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
          <pre class="text-sm text-red-700 whitespace-pre-wrap font-mono bg-red-100 p-4 rounded overflow-x-auto"><%= @import_run.error_message %></pre>
        </div>
      </div>
    <% end %>

    <!-- Related Runs -->
    <div class="mt-8 bg-white shadow rounded-lg">
      <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Other Runs from this Source</h3>
      </div>
      <ul class="divide-y divide-gray-200">
        <% @import_run.source.import_runs.where.not(id: @import_run.id).recent.limit(5).each do |run| %>
          <li class="px-4 py-3 sm:px-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <% case run.status %>
                <% when "completed" %>
                  <span class="flex-shrink-0 w-2.5 h-2.5 rounded-full bg-green-400"></span>
                <% when "failed" %>
                  <span class="flex-shrink-0 w-2.5 h-2.5 rounded-full bg-red-400"></span>
                <% else %>
                  <span class="flex-shrink-0 w-2.5 h-2.5 rounded-full bg-yellow-400 animate-pulse"></span>
                <% end %>
                <span class="ml-3 text-sm text-gray-900">
                  <%= run.started_at.strftime("%Y-%m-%d %H:%M") %>
                </span>
              </div>
              <div class="flex items-center space-x-4">
                <span class="text-sm text-green-600">+<%= run.items_created %></span>
                <%= link_to "View", admin_import_run_path(run), class: "text-sm text-blue-600 hover:underline" %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
      <div class="px-4 py-3 border-t border-gray-200">
        <%= link_to "View all runs from this source →", admin_import_runs_path(source_id: @import_run.source_id), class: "text-sm text-blue-600 hover:underline" %>
      </div>
    </div>
  </div>
</div>
