<%= form_with(model: [:admin, subscriber_segment], class: "space-y-6") do |form| %>
  <% if subscriber_segment.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800"><%= t('errors.form_errors', count: subscriber_segment.errors.count) %></h3>
          <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
            <% subscriber_segment.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div>
    <%= form.label :name, t('admin.subscriber_segments.form.name'), class: "block text-sm font-medium text-gray-700" %>
    <%= form.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: t('admin.subscriber_segments.form.name_placeholder'), required: true %>
  </div>

  <div>
    <%= form.label :description, t('admin.subscriber_segments.form.description'), class: "block text-sm font-medium text-gray-700" %>
    <%= form.text_area :description, rows: 2, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", placeholder: t('admin.subscriber_segments.form.description_placeholder') %>
  </div>

  <div class="flex items-center">
    <%= form.check_box :enabled, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
    <%= form.label :enabled, t('admin.subscriber_segments.form.enabled'), class: "ml-2 block text-sm text-gray-700" %>
  </div>

  <div class="border-t border-gray-200 pt-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t('admin.subscriber_segments.form.rules_section') %></h3>

    <div class="space-y-6">
      <%# Subscription Age %>
      <fieldset class="border border-gray-200 rounded-md p-4">
        <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.subscription_age') %></legend>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <%= form.label "rules[subscription_age][min_days]", t('admin.subscriber_segments.form.subscription_min_days'), class: "block text-sm text-gray-600" %>
            <%= form.number_field "rules[subscription_age][min_days]", value: subscriber_segment.rules.dig("subscription_age", "min_days"), min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
          </div>
          <div>
            <%= form.label "rules[subscription_age][max_days]", t('admin.subscriber_segments.form.subscription_max_days'), class: "block text-sm text-gray-600" %>
            <%= form.number_field "rules[subscription_age][max_days]", value: subscriber_segment.rules.dig("subscription_age", "max_days"), min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
          </div>
        </div>
      </fieldset>

      <%# Engagement Level %>
      <fieldset class="border border-gray-200 rounded-md p-4">
        <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.engagement_level') %></legend>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <%= form.label "rules[engagement_level][min_actions]", t('admin.subscriber_segments.form.engagement_min_actions'), class: "block text-sm text-gray-600" %>
            <%= form.number_field "rules[engagement_level][min_actions]", value: subscriber_segment.rules.dig("engagement_level", "min_actions"), min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
          </div>
          <div>
            <%= form.label "rules[engagement_level][within_days]", t('admin.subscriber_segments.form.engagement_within_days'), class: "block text-sm text-gray-600" %>
            <%= form.number_field "rules[engagement_level][within_days]", value: subscriber_segment.rules.dig("engagement_level", "within_days") || 30, min: 1, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
          </div>
        </div>
      </fieldset>

      <%# Referral Count %>
      <fieldset class="border border-gray-200 rounded-md p-4">
        <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.referral_count') %></legend>
        <div>
          <%= form.label "rules[referral_count][min]", t('admin.subscriber_segments.form.referral_min'), class: "block text-sm text-gray-600" %>
          <%= form.number_field "rules[referral_count][min]", value: subscriber_segment.rules.dig("referral_count", "min"), min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>
      </fieldset>

      <%# Tags %>
      <% if subscriber_tags.any? %>
        <fieldset class="border border-gray-200 rounded-md p-4">
          <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.tags') %></legend>
          <div class="space-y-4">
            <div>
              <%= form.label "rules[tags][any][]", t('admin.subscriber_segments.form.tags_any'), class: "block text-sm text-gray-600" %>
              <%= form.select "rules[tags][any][]", subscriber_tags.map { |t| [t.name, t.slug] }, { include_blank: true }, multiple: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", data: { selected: subscriber_segment.rules.dig("tags", "any") || [] } %>
            </div>
            <div>
              <%= form.label "rules[tags][all][]", t('admin.subscriber_segments.form.tags_all'), class: "block text-sm text-gray-600" %>
              <%= form.select "rules[tags][all][]", subscriber_tags.map { |t| [t.name, t.slug] }, { include_blank: true }, multiple: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", data: { selected: subscriber_segment.rules.dig("tags", "all") || [] } %>
            </div>
          </div>
        </fieldset>
      <% end %>

      <%# Frequency %>
      <fieldset class="border border-gray-200 rounded-md p-4">
        <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.frequency') %></legend>
        <div>
          <%= form.select "rules[frequency]", [["", ""], [t('admin.subscriber_segments.form.frequency_weekly'), "weekly"], [t('admin.subscriber_segments.form.frequency_daily'), "daily"]], { selected: subscriber_segment.rules["frequency"] }, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>
      </fieldset>

      <%# Active %>
      <fieldset class="border border-gray-200 rounded-md p-4">
        <legend class="text-sm font-medium text-gray-700 px-2"><%= t('admin.subscriber_segments.form.active') %></legend>
        <div>
          <%= form.select "rules[active]", [["", ""], [t('admin.subscriber_segments.form.active_only'), "true"], [t('admin.subscriber_segments.form.inactive_only'), "false"]], { selected: subscriber_segment.rules.key?("active") ? subscriber_segment.rules["active"].to_s : "" }, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" %>
        </div>
      </fieldset>
    </div>
  </div>

  <div class="flex justify-end space-x-3">
    <%= link_to t('admin.subscriber_segments.form.cancel'), admin_subscriber_segments_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    <%= form.submit subscriber_segment.persisted? ? t('admin.subscriber_segments.form.update') : t('admin.subscriber_segments.form.create'), class: "inline-flex items-center px-4 py-2 <%= button_classes(variant: :primary) %> cursor-pointer" %>
  </div>
<% end %>
