name: Create Release

on:
  workflow_run:
    workflows: ["Deploy to Dokku"]
    types:
      - completed
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Use the exact SHA from the deploy workflow run
          DEPLOY_SHA="${{ github.event.workflow_run.head_sha }}"

          # Generate version based on date and short SHA
          VERSION="v$(date +'%Y.%m.%d')-${DEPLOY_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Get commit message for release notes
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" "$DEPLOY_SHA")
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

          # Get list of changes since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGES=$(git log ${LAST_TAG}..${DEPLOY_SHA} --pretty=format:"- %s" --no-merges | head -20)
          else
            CHANGES=$(git log ${DEPLOY_SHA} --pretty=format:"- %s" --no-merges -20)
          fi

          # Store changes in a file for multiline support
          echo "$CHANGES" > /tmp/changes.txt

      - name: Generate release notes
        id: notes
        run: |
          cat << 'EOF' > /tmp/release_notes.md
          ## Deployed to Production

          This release was automatically deployed to [curated.cx](https://curated.cx).

          ### Recent Changes

          EOF
          cat /tmp/changes.txt >> /tmp/release_notes.md
          cat << 'EOF' >> /tmp/release_notes.md

          ### Deployment Info

          - **Commit**: ${{ github.event.workflow_run.head_sha }}
          - **Deployed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Triggered by**: ${{ github.actor }}
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
