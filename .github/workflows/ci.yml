name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  RUBY_VERSION: '3.3'
  NODE_VERSION: '20'
  RAILS_ENV: test
  DATABASE_URL: postgres://postgres:password@localhost:5432/curated_test

jobs:
  # Fast feedback jobs - run in parallel
  lint-and-format:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      - name: Run RuboCop
        run: bundle exec rubocop --format progress --format json --out rubocop-results.json
        continue-on-error: true

      - name: Run ERB Lint
        run: bundle exec erb_lint --lint-all --format json --out erb-lint-results.json
        continue-on-error: true

      - name: Run JavaScript linting
        run: npm run lint
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: |
            rubocop-results.json
            erb-lint-results.json

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      - name: Run Brakeman
        run: bundle exec brakeman --format json --output brakeman-results.json
        continue-on-error: true

      - name: Run Bundle Audit
        run: bundle exec bundle-audit check --update
        continue-on-error: true

      - name: Run NPM Audit
        run: npm audit --audit-level=moderate --json > npm-audit-results.json
        continue-on-error: true

      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-results
          path: |
            brakeman-results.json
            npm-audit-results.json

  # Main test suite with all integrated tests
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: curated_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      - name: Build assets
        run: |
          npm run build
          npm run build:css

      - name: Setup test database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: Run RSpec tests (models, requests, helpers, policies)
        run: bundle exec rspec --exclude-pattern "spec/{performance,system,accessibility}/**/*_spec.rb" --format progress --format json --out rspec-results.json
        env:
          COVERAGE: true

      - name: Run Performance tests
        run: bundle exec rspec --options .rspec-performance spec/performance/ --format progress --format json --out performance-results.json
        continue-on-error: true

      - name: Run Accessibility tests
        run: bundle exec rspec spec/system/accessibility_spec.rb --format progress --format json --out accessibility-results.json
        continue-on-error: true

      - name: Run i18n tests
        run: bundle exec rspec spec/i18n_spec.rb --format progress --format json --out i18n-results.json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            rspec-results.json
            performance-results.json
            accessibility-results.json
            i18n-results.json

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage/

  # Code quality analysis - runs after basic tests pass
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: [lint-and-format, security, test]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Run Rails Best Practices
        run: bundle exec rails_best_practices --format json --output rails-bp-results.json
        continue-on-error: true

      - name: Run i18n health check
        run: |
          bundle exec i18n-tasks health --format json > i18n-health-results.json
          bundle exec i18n-tasks missing --format json > i18n-missing-results.json
          bundle exec i18n-tasks unused --format json > i18n-unused-results.json
        continue-on-error: true

      - name: Install and run code complexity analysis
        run: |
          gem install flog
          flog app/ --all --format json > flog-results.json
        continue-on-error: true

      - name: Install and run dead code detection
        run: |
          gem install debride
          debride app/ --format json > debride-results.json
        continue-on-error: true

      - name: Upload code quality results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-results
          path: |
            rails-bp-results.json
            i18n-health-results.json
            i18n-missing-results.json
            i18n-unused-results.json
            flog-results.json
            debride-results.json

      - name: Comment on PR with quality issues
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let comment = '## Code Quality Analysis\n\n';
            
            try {
              const bpResults = JSON.parse(fs.readFileSync('rails-bp-results.json', 'utf8'));
              if (bpResults.length > 0) {
                comment += '### Rails Best Practices Issues\n';
                bpResults.slice(0, 5).forEach(issue => {
                  comment += `- **${issue.filename}:${issue.line_number}** - ${issue.message}\n`;
                });
                if (bpResults.length > 5) {
                  comment += `- ... and ${bpResults.length - 5} more issues\n`;
                }
                comment += '\n';
              } else {
                comment += '✅ No Rails Best Practices issues found\n\n';
              }
            } catch (error) {
              comment += '⚠️ Could not parse Rails Best Practices results\n\n';
            }
            
            try {
              const i18nHealth = JSON.parse(fs.readFileSync('i18n-health-results.json', 'utf8'));
              if (i18nHealth.issues && i18nHealth.issues.length > 0) {
                comment += '### i18n Issues\n';
                i18nHealth.issues.slice(0, 3).forEach(issue => {
                  comment += `- ${issue.message}\n`;
                });
                comment += '\n';
              } else {
                comment += '✅ No i18n issues found\n\n';
              }
            } catch (error) {
              comment += '⚠️ Could not parse i18n results\n\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Build verification - runs after all quality checks
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint-and-format, security, test, code-quality]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install production dependencies
        run: |
          bundle install --jobs 4 --retry 3 --without development test
          npm ci

      - name: Build assets
        run: |
          npm run build
          npm run build:css

      - name: Precompile assets
        run: bundle exec rails assets:precompile
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: dummy_key_for_build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            public/assets/
            app/assets/builds/

  # Summary job - provides overall status
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, security, test, code-quality, build]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: CI Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check job statuses
          if [ "${{ needs.lint-and-format.result }}" == "success" ]; then
            echo "| Lint & Format | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lint & Format | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "| Security | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| Tests | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "| Code Quality | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Quality | ⚠️ Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| Build | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical**: Lint, Security, Tests, Build must pass" >> $GITHUB_STEP_SUMMARY
          echo "- **Warning**: Code Quality issues should be addressed" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance**: Integrated into test suite" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility**: Integrated into test suite" >> $GITHUB_STEP_SUMMARY
          echo "- **i18n**: Integrated into test suite" >> $GITHUB_STEP_SUMMARY
