# Consolidated CI Pipeline
# All quality gates in one workflow for efficiency and clarity
#
# Quality Gates (MUST PASS):
# 1. Code Style - RuboCop (Rails Omakase) + ERB Lint + JavaScript lint
# 2. Security - Brakeman + Bundle Audit
# 3. Tests - RSpec with coverage
# 4. Build - Asset compilation verification
#
# Advisory Checks (warnings only):
# - Code quality analysis (RubyCritic, Reek, Fasterer)
# - i18n health checks
# - Complexity analysis

name: CI

on:
  push:
    branches: [develop]  # main is handled by deploy.yml which calls this workflow
  pull_request:
    branches: [main, develop]
  workflow_call:
    # Allow this workflow to be called by other workflows (e.g., deploy.yml)

env:
  RUBY_VERSION: '3.4'
  NODE_VERSION: '20'
  RAILS_ENV: test
  DATABASE_URL: postgres://postgres:password@localhost:5432/curated_test

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # STAGE 1: Fast Feedback (parallel)
  # ============================================================

  lint:
    name: Code Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      # CRITICAL: RuboCop must pass
      - name: Run RuboCop
        run: bundle exec rubocop --format progress

      # CRITICAL: ERB Lint must pass (only app views, not vendor/)
      - name: Run ERB Lint
        run: bundle exec erb_lint app/views/

      # CRITICAL: JavaScript lint must pass
      - name: Run JavaScript linting
        run: npm run lint

      # CRITICAL: Prettier formatting must pass
      - name: Check Prettier formatting
        run: npm run format:check

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      # CRITICAL: Brakeman security scan must pass (no high/medium)
      - name: Run Brakeman
        run: bundle exec brakeman -q --no-pager -i .brakeman.ignore

      # CRITICAL: Bundle Audit must pass (no known vulnerabilities)
      - name: Run Bundle Audit
        run: bundle exec bundle-audit check --update

      # ADVISORY: NPM Audit (moderate and above)
      - name: Run NPM Audit
        run: npm audit --audit-level=high || echo "::warning::NPM audit found issues"
        continue-on-error: true

  test:
    name: Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: curated_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3
          npm ci

      - name: Build assets
        run: |
          npm run build
          npm run build:css

      - name: Setup test database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      # CRITICAL: All tests must pass
      - name: Run RSpec tests
        run: bundle exec rspec --exclude-pattern "spec/{performance,system}/**/*_spec.rb" --format progress
        env:
          COVERAGE: true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  # ============================================================
  # STAGE 2: Build Verification (requires lint, security, test)
  # ============================================================

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install production dependencies
        run: |
          bundle config set --local without 'development test'
          bundle install --jobs 4 --retry 3
          npm ci

      - name: Build assets
        run: |
          npm run build
          npm run build:css

      # CRITICAL: Asset precompilation must succeed
      - name: Precompile assets
        run: bundle exec rails assets:precompile
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: dummy_key_for_build_verification

  # ============================================================
  # STAGE 3: Advisory Quality Checks (parallel, non-blocking)
  # ============================================================

  quality-analysis:
    name: Quality Analysis
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    if: always() && needs.test.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      # ADVISORY: Rails Best Practices
      - name: Run Rails Best Practices
        run: bundle exec rails_best_practices --format json --output tmp/rails-bp-results.json || true
        continue-on-error: true

      # ADVISORY: i18n health check
      - name: Run i18n health check
        run: |
          bundle exec i18n-tasks health || echo "::warning::i18n health check found issues"
          bundle exec i18n-tasks missing || echo "::warning::Missing i18n keys found"
        continue-on-error: true

      # ADVISORY: Code quality metrics
      - name: Run RubyCritic
        run: bundle exec rubycritic --no-browser app/ lib/ --minimum-score 80 || echo "::warning::Code quality below threshold"
        continue-on-error: true

      # ADVISORY: Code smell detection
      - name: Run Reek
        run: bundle exec reek app/ lib/ --format json > tmp/reek-results.json 2>&1 || echo "::warning::Code smells detected"
        continue-on-error: true

      - name: Upload quality results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: quality-results
          path: tmp/*-results.json
          retention-days: 7

  # ============================================================
  # STAGE 4: Summary
  # ============================================================

  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, quality-analysis]
    if: always()
    steps:
      - name: Check critical gates
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Check each critical gate
          FAILED=false

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "| Code Style | ✅ Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Style | ❌ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "| Security | ✅ Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security | ❌ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| Tests | ✅ Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests | ❌ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| Build | ✅ Passed | Yes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | ❌ Failed | Yes |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [ "${{ needs.quality-analysis.result }}" == "success" ]; then
            echo "| Quality Analysis | ✅ Passed | No |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Quality Analysis | ⚠️ Issues | No |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" = true ]; then
            echo "### ❌ CI Failed" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical quality gates failed. Please fix the issues above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### ✅ CI Passed" >> $GITHUB_STEP_SUMMARY
            echo "All critical quality gates passed. Ready for deployment." >> $GITHUB_STEP_SUMMARY
          fi
