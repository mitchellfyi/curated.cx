#!/bin/bash

# Quality Check Script for Curated.cx
# Matches GitHub Actions CI workflows

echo "üîç Running Quality Checks..."
echo "=============================="

# Initialize counters
TOTAL_ISSUES=0
CRITICAL_ISSUES=0

# Create results directory
mkdir -p tmp/quality-results

echo
echo "1Ô∏è‚É£ RuboCop (Ruby Code Style)"
echo "----------------------------"
if bundle exec rubocop --format progress --format json --out tmp/quality-results/rubocop-results.json; then
    echo "‚úÖ RuboCop: PASSED"
else
    echo "‚ùå RuboCop: FAILED"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "2Ô∏è‚É£ ERB Lint (Template Quality)"
echo "-------------------------------"
if bundle exec erb_lint --lint-all --format json --out tmp/quality-results/erb-lint-results.json; then
    echo "‚úÖ ERB Lint: PASSED"
else
    echo "‚ö†Ô∏è  ERB Lint: Issues found"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "3Ô∏è‚É£ Brakeman (Security Analysis)"
echo "--------------------------------"
if bundle exec brakeman --format json --output tmp/quality-results/brakeman-results.json; then
    echo "‚úÖ Brakeman: PASSED (No security issues)"
else
    echo "‚ùå Brakeman: SECURITY ISSUES FOUND"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "4Ô∏è‚É£ Bundle Audit (Dependency Security)"
echo "--------------------------------------"
if bundle exec bundle-audit check --update; then
    echo "‚úÖ Bundle Audit: PASSED"
else
    echo "‚ùå Bundle Audit: VULNERABILITIES FOUND"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "5Ô∏è‚É£ Rails Best Practices"
echo "------------------------"
if bundle exec rails_best_practices --format json --output tmp/quality-results/rails-bp-results.json; then
    echo "‚úÖ Rails Best Practices: PASSED"
else
    echo "‚ö†Ô∏è  Rails Best Practices: Issues found"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "6Ô∏è‚É£ i18n Tests"
echo "-------------"
if bundle exec rspec spec/i18n_integrated_spec.rb --format progress; then
    echo "‚úÖ i18n Tests: PASSED"
else
    echo "‚ö†Ô∏è  i18n Tests: Issues found"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "7Ô∏è‚É£ Test Suite"
echo "--------------"
if bundle exec rspec --exclude-pattern "spec/{performance,system/accessibility_integrated_spec.rb,i18n_integrated_spec.rb}" --format progress --format json --out tmp/quality-results/rspec-results.json; then
    echo "‚úÖ Tests: PASSED"
else
    echo "‚ùå Tests: Some failures"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "8Ô∏è‚É£ Accessibility Tests"
echo "----------------------"
if bundle exec rspec spec/system/accessibility_integrated_spec.rb --format progress; then
    echo "‚úÖ Accessibility Tests: PASSED"
else
    echo "‚ö†Ô∏è  Accessibility Tests: Issues found"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "9Ô∏è‚É£ Performance Tests"
echo "--------------------"
if bundle exec rspec --options .rspec-performance spec/performance/ --format progress; then
    echo "‚úÖ Performance Tests: PASSED"
else
    echo "‚ö†Ô∏è  Performance Tests: Issues found"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "üìä QUALITY SUMMARY"
echo "=================="
echo "Total Issues: $TOTAL_ISSUES"
echo "Critical Issues: $CRITICAL_ISSUES"
echo "Results saved to: tmp/quality-results/"

if [ $CRITICAL_ISSUES -eq 0 ]; then
    echo "üéâ Ready to commit! Critical issues resolved."
    exit 0
else
    echo "üö´ Fix critical issues before committing."
    exit 1
fi