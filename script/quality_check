#!/bin/bash

# Quality Check Script for Curated.cx
echo "ğŸ” Running Quality Checks..."
echo "=============================="

# Initialize counters
TOTAL_ISSUES=0
CRITICAL_ISSUES=0

echo
echo "1ï¸âƒ£ RuboCop (Ruby Code Style)"
echo "----------------------------"
if bundle exec rubocop --format progress; then
    echo "âœ… RuboCop: PASSED"
else
    echo "âŒ RuboCop: FAILED"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "2ï¸âƒ£ Brakeman (Security Analysis)"
echo "--------------------------------"
if bundle exec brakeman --no-pager -q; then
    echo "âœ… Brakeman: PASSED (No security issues)"
else
    echo "âŒ Brakeman: SECURITY ISSUES FOUND"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "3ï¸âƒ£ ERB Lint (Template Quality)"
echo "-------------------------------"
if bundle exec erb_lint --lint-all --format compact > /dev/null 2>&1; then
    echo "âœ… ERB Lint: PASSED"
else
    echo "âš ï¸  ERB Lint: Issues found (mostly formatting)"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "4ï¸âƒ£ Rails Best Practices"
echo "------------------------"
RAILS_BP_OUTPUT=$(bundle exec rails_best_practices --silent . 2>/dev/null | tail -1)
if [[ "$RAILS_BP_OUTPUT" == *"Found 0 warnings"* ]]; then
    echo "âœ… Rails Best Practices: PASSED"
else
    echo "âš ï¸  Rails Best Practices: $RAILS_BP_OUTPUT"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
fi

echo
echo "5ï¸âƒ£ Test Suite"
echo "--------------"
if bundle exec rspec --format progress > /dev/null 2>&1; then
    echo "âœ… Tests: PASSED"
else
    echo "âŒ Tests: Some failures"
    TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

echo
echo "ğŸ“Š QUALITY SUMMARY"
echo "=================="
echo "Total Issues: $TOTAL_ISSUES"
echo "Critical Issues: $CRITICAL_ISSUES"

if [ $CRITICAL_ISSUES -eq 0 ]; then
    echo "ğŸ‰ Ready to commit! Critical issues resolved."
    exit 0
else
    echo "ğŸš« Fix critical issues before committing."
    exit 1
fi