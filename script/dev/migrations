#!/usr/bin/env ruby
# Database migration safety checker and helper

puts "ğŸ—„ï¸  Database Migration Safety Tools"
puts "=" * 50

def run_command(description, command)
  puts "\n#{description}"
  puts "-" * 30
  result = system(command)
  unless result
    puts "âš ï¸  Command failed or found issues"
  end
  result
end

# Check migration status
run_command("ğŸ“‹ Checking migration status:", "bundle exec rails db:migrate:status")

# Run strong_migrations check on pending migrations
run_command("ğŸ” Checking for unsafe migrations:", "bundle exec rails db:migrate RAILS_ENV=development")

# Check for missing indexes on foreign keys
puts "\nğŸ”— Checking for missing indexes on foreign keys..."
puts "-" * 30
puts "â„¹ï¸  This requires manual review of the schema"

# Display migration best practices
puts "\nğŸ’¡ Migration Best Practices:"
puts "  ğŸ“ DO:"
puts "    â€¢ Add indexes concurrently: add_index :table, :column, algorithm: :concurrently"
puts "    â€¢ Use smaller lock timeouts in production"
puts "    â€¢ Add columns without default values, then backfill"
puts "    â€¢ Remove columns in separate deployments after code changes"
puts "    â€¢ Use disable_ddl_transaction! for concurrent operations"
puts "    â€¢ Test migrations on production-sized data"
puts ""
puts "  âŒ DON'T:"
puts "    â€¢ Add columns with default values to large tables"
puts "    â€¢ Change column types directly"
puts "    â€¢ Remove columns that are still in use"
puts "    â€¢ Create indexes on large tables without CONCURRENTLY"
puts "    â€¢ Run long-running migrations during peak hours"

puts "\nğŸ“š Useful Commands:"
puts "  bundle exec rails db:migrate:status           # Check migration status"
puts "  bundle exec rails db:migrate:up VERSION=123   # Run specific migration"
puts "  bundle exec rails db:migrate:down VERSION=123 # Rollback specific migration"
puts "  bundle exec rails db:rollback STEP=3          # Rollback last 3 migrations"
puts "  bundle exec rails db:schema:load               # Load schema without running migrations"

puts "\nğŸ”§ Strong Migrations Commands:"
puts "  StrongMigrations.disable_check(:add_index)    # Disable specific check"
puts "  safety_assured do; add_column(...); end       # Override safety check"

puts "\nâœ… Migration safety check complete!"
