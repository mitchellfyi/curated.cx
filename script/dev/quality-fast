#!/usr/bin/env bash
# Fast Quality Check Script - Essential checks only
# For full checks, use ./script/dev/quality

echo "âš¡ FAST QUALITY CHECK"
echo "=============================="

# Check if there are staged files to lint
staged_ruby_files=$(git diff --cached --name-only --diff-filter=AM | grep '\.rb$' | tr '\n' ' ' | sed 's/[[:space:]]*$//')
staged_erb_files=$(git diff --cached --name-only --diff-filter=AM | grep '\.erb$' | tr '\n' ' ' | sed 's/[[:space:]]*$//')

if [[ -z "$staged_ruby_files" && -z "$staged_erb_files" ]]; then
  echo "âœ… No staged Ruby/ERB files to check"
  echo "ğŸ’¡ Run './script/dev/quality' for full validation"
  exit 0
fi

exit_code=0

if [[ -n "$staged_ruby_files" ]]; then
  echo "ğŸ“‹ RuboCop (staged files)"
  start_time=$(date +%s.%N)
  if bundle exec rubocop $staged_ruby_files >/dev/null 2>&1; then
    duration=$(echo "$(date +%s.%N) - $start_time" | bc)
    echo "âœ… RuboCop passed (${duration}s)"
  else
    duration=$(echo "$(date +%s.%N) - $start_time" | bc)
    echo "âŒ RuboCop failed (${duration}s)"
    exit_code=1
  fi
fi

if [[ -n "$staged_erb_files" ]]; then
  echo "ğŸ“‹ ERB Lint (staged files)"
  start_time=$(date +%s.%N)
  if bundle exec erb_lint $staged_erb_files >/dev/null 2>&1; then
    duration=$(echo "$(date +%s.%N) - $start_time" | bc)
    echo "âœ… ERB Lint passed (${duration}s)"
  else
    duration=$(echo "$(date +%s.%N) - $start_time" | bc)
    echo "âŒ ERB Lint failed (${duration}s)"
    exit_code=1
  fi
fi

if [[ $exit_code -eq 0 ]]; then
  echo "âœ… Fast checks passed!"
else
  echo "ğŸ’¥ Some checks failed - fix and retry"
fi

echo "ğŸ’¡ Run './script/dev/quality' for full validation"
exit $exit_code