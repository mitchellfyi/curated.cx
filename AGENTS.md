<!--
Generated by dk | 2026-01-20T21:05:35.129Z
Source: .doyaken/agents/codex.yaml

This file points to the source of truth in .doyaken/
To update instructions, edit files in .doyaken/prompts/
-->

# Agent Instructions

This project uses dk for AI configuration. All instructions live in `.doyaken/`.

## Read These Files

- `.doyaken/prompts/base.md`
- `.doyaken/prompts/code/_default.md`

## Playbook

Follow the methodology in `.doyaken/playbook.md` for all coding tasks.

## Additional Prompts

Task-specific prompts in `.doyaken/prompts/`:

- `.doyaken/prompts/review.md` - Code Review
- `.doyaken/prompts/optimize.md` - Code Optimization
- `.doyaken/prompts/mission-tasks.md` - Generate Mission Tasks
- `.doyaken/prompts/improve.md` - Code Improvement

## Git Workflow

**CRITICAL: Commit Early and Often**

When the agent completes work, commits should be made frequently:

- **After each logical unit of work** - Don't wait until everything is "done"
- **After passing quality gates** - Commit when tests pass and quality checks are green
- **After each feature increment** - Small, focused commits are preferred
- **Use Conventional Commits format** - Clear, descriptive commit messages
- **Commit working state** - Even if a feature is partially complete, commit the working state

**Commit Frequency Guidelines:**
- Commit after completing a single task or subtask
- Commit after fixing a bug or issue
- Commit after adding tests for a feature
- Commit after refactoring a specific area
- Don't accumulate multiple unrelated changes in a single commit

**Commit Message Format:**
```
<type>(<scope>): <subject>

<body>

<footer>
```

Examples:
- `feat(listings): add source model and migration`
- `fix(ingestion): handle race conditions in URL upserts`
- `test(services): add specs for UrlCanonicaliser`
- `refactor(admin): extract listings service logic`

This ensures:
- Better code history and rollback capability
- Easier collaboration and code review
- Clearer understanding of what changed and why
- Reduced risk of losing work

## Quality Assurance

**CRITICAL: Always Run Quality Script After Completing Work**

Before committing any changes, the agent MUST run the quality script to ensure all quality gates pass:

- **Run `./bin/quality`** after completing all work on a task or feature
- **All quality gates must pass** before committing code
- **Fix any quality failures immediately** - do not commit code that fails quality checks
- **Re-run quality script** after fixing any issues to verify all gates pass

**Quality Check Workflow:**
1. Complete the work (implement feature, fix bug, add tests, etc.)
2. Run `./bin/quality` to execute all quality gates
3. Review any failures and fix them
4. Re-run `./bin/quality` until all gates pass
5. Only then proceed with commit

**Quality Gates Include:**
- RuboCop + SOLID Principles compliance
- Brakeman security checks
- RSpec test suite (100% passing, 80% coverage minimum)
- Route testing validation
- i18n-tasks (no missing translations)
- ERB Lint
- SEO Optimization
- Accessibility (WCAG 2.1 AA)
- Performance (no N+1 queries)
- Strong Migrations validation
- Bundle Audit (security vulnerabilities)
- Database integrity checks

**No Exceptions:** Code that fails quality gates must not be committed. Fix issues first, then commit.
