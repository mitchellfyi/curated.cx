# Curated.cx Fix Progress

Started: 2026-02-05 11:00 UTC
Target: Complete by 17:00 UTC (6 hours)
Cron: "Curated Fix Session" runs every 30 min

## Issues to Fix

### 1. Dashboard link in user nav - broken
- [x] Investigated routes - `resource :dashboard` exists and is correct
- [x] Investigated view - `dashboard_path` used correctly in navigation
- [ ] May be tenant context issue - need to verify
- [ ] Test locally or check production logs

### 2. /admin/observability sub pages broken
- [x] Routes verified - `resource :observability` with member routes for imports, editorialisations, serp_api, ai_usage
- [x] Controller verified - all actions exist with proper stats building
- [x] Views verified - all view files exist (show, imports, editorialisations, serp_api, ai_usage)
- [ ] Need to identify actual error - may be stats nil or template rendering issue

### 3. API usage not visible on observability page
- [x] SerpAPI stats are assigned in controller: `@serp_api_stats = SerpApiGlobalRateLimiter.usage_stats`
- [x] AI usage stats assigned: `@ai_usage_stats = AiUsageTracker.usage_stats`
- [x] Dedicated pages exist: /admin/observability/serp_api, /admin/observability/ai_usage
- [ ] Verify if these are linked properly in main observability page

### 4. /admin/jobs broken + jobs failing
- [x] MissionControl::Jobs gem is installed (v1.1.0)
- [x] Route exists: `mount MissionControl::Jobs::Engine, at: "/admin/jobs"`
- [x] Added mission_control.rb initializer
- [ ] SolidQueue is the queue adapter in production
- [ ] Queue database configured but no queue_migrate folder exists (uses queue_schema.rb)
- [ ] Need to check if SolidQueue tables exist in production

## Files Changed
- config/initializers/mission_control.rb (new) - MissionControl configuration
- app/services/ai_usage_tracker.rb - Added missing keys expected by views

## Commits
- 2f6902f - Fix AiUsageTracker.usage_stats to include all keys expected by views
- 593bcdd - Update progress doc
- 5383d12 - Update mission_control initializer with better configuration
- d62660d - Add request spec for user dashboard

## Progress Log

### 11:00 UTC - Starting investigation
- Reviewed routes.rb - all routes correctly defined
- Reviewed observability_controller.rb - all actions present
- Reviewed all observability views - exist and look correct
- Verified navigation uses correct path helpers
- Added mission_control.rb initializer

### 11:15 UTC - Found and fixed AiUsageTracker mismatch
- The ai_usage.html.erb view was accessing keys that didn't exist
- Added missing keys to usage_stats:
  - cost[:monthly][:percent_used, :used_dollars, :limit_dollars]
  - cost[:daily][:used_dollars, :soft_limit_cents]
  - tokens[:monthly][:percent_used, :input, :output]
  - projections[:projected_monthly_dollars]
  - requests[:total_today, :avg_tokens_per_request, :avg_cost_cents_per_request]
- Added monthly_input_tokens and monthly_output_tokens methods
- Committed fix

### 11:20 UTC - More fixes
- Updated mission_control.rb initializer with better configuration
- Added request spec for user dashboard (was missing)
- Pushed all changes

### Next Steps (for cron continuation)
1. Check CI results when available
2. Need production access to verify actual errors (Sentry or logs)
3. If issues persist after AiUsageTracker fix, check for similar view/service mismatches
4. Verify SolidQueue jobs are running in production
5. May need to run specific tests locally with Docker

### Questions for Mitchell
- Can you share any error messages you see when visiting the broken pages?
- Do you have access to Sentry error logs for curated.cx?
- When you say "dashboard link broken", does it:
  a) Not show up at all?
  b) Show up but lead to a 404?
  c) Show up but lead to a 500 error?
  d) Load but show incorrect data?

### 11:25 UTC - CI Debug
- CI failing with `FATAL: role "root" does not exist` in postgres
- Investigating whether this is a flaky CI issue or related to recent changes
- Workflow-level DATABASE_URL should propagate but Rails might be ignoring it
